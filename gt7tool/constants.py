from typing import Optional

from crcmod.crcmod import _mkTable as make_crc_table

INDEX_MAGIC = 0x5B745163
INDEX_HEADER_SIZE = 0x800
FORMATTER_CODE = 0x11160000
MAX_VOLUMES = 100

CLUSTER_MAGIC = 0x2B26958523AD
PACKED_FILE_ZSTD_MAGIC = 0xFFF7972F
PACKED_FILE_ZLIB_MAGIC = 0xFFF7EEC5
DATA_ALIGNMENT = 0x400

FORMAT_PLAIN = 0
FORMAT_PZ1 = 1
FORMAT_PZ2 = 2
FORMAT_PFS = 3

KIND_LUMP = 0
KIND_FRAG = 1

ALGO_ZLIB = 0
ALGO_ZSTD = 1
ALGO_KRAKEN = 2

NODE_FLAG_FORMAT_MASK = 0x3
NODE_FLAG_FORMAT_SHIFT = 0
NODE_FLAG_KIND_MASK = 0x30
NODE_FLAG_KIND_SHIFT = 4
NODE_FLAG_ALGO_MASK = 0xC0
NODE_FLAG_ALGO_SHIFT = 6

# TODO: What other bits are doing?
NODE_EXTRA_FLAG_UNK_MASK = 0x7F
NODE_EXTRA_FLAG_UNK_SHIFT = 0

NODE_EXTRA_FLAG_USE_VOLUME_MASK = 0x80
NODE_EXTRA_FLAG_USE_VOLUME_SHIFT = 7

INDEX_CIPHER_KEY = bytes.fromhex('FB3EC12D88352C39F1663EE20404CB8C1D47FEF2723B1346F7D37E1BBDC45FA6')
INDEX_CIPHER_IV = bytes.fromhex('0921E1C5581FAB3500000000')
VOLUME_CIPHER_KEY = bytes.fromhex('613ED44EB71DD6169CCAA0066D2902B890C028A3C59A986624DDAD80FBF3049B')

CRC32_TABLE = make_crc_table(0x104C11DB7, 32)

CIPHER_INITIAL_CRC = 0xA7E4A1E8

CACHE_NAME_LOOKUP_TABLE = 'P6MH85C24L91ZTIYURQ7NKJ0OSBWDAVGX3FE'
